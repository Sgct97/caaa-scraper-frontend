<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAAA Legal Intelligence | AI-Powered Research Platform</title>
    
    <!-- Access Control -->
    <script>
        (function() {
            const ACCESS_CODE = "CAAA2025";
            const stored = sessionStorage.getItem('caaa_access_granted');
            
            if (stored !== ACCESS_CODE) {
                const entered = prompt("Enter access code to continue:");
                if (entered === ACCESS_CODE) {
                    sessionStorage.setItem('caaa_access_granted', ACCESS_CODE);
                } else {
                    document.write('<html><body style="margin:0;display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#f3f4f6;"><div style="text-align:center;"><h1 style="color:#ef4444;font-size:48px;margin:0;">Access Denied</h1><p style="color:#6b7280;font-size:18px;margin-top:10px;">Invalid access code</p></div></body></html>');
                    document.close();
                    throw new Error('Access denied');
                }
            }
        })();
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .search-box-shadow {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <!-- Navigation -->
    <nav class="glass border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-balance-scale text-primary-600 text-2xl mr-3"></i>
                        <span class="text-2xl font-bold bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">
                            CAAA Legal Intelligence
                        </span>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="http://134.199.196.31:8000/admin/refresh-cookies" 
                       target="_blank"
                       class="text-gray-500 hover:text-primary-600 transition-colors flex items-center text-sm"
                       title="Refresh CAAA Login (Admin)">
                        <i class="fas fa-key mr-1"></i>
                        Refresh Login
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Hero Section -->
        <div class="mb-12">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold text-gray-900 mb-4">
                    Legal Research, <span class="bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">Supercharged</span>
                </h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    Search with precision using all CAAA fields, or let our AI assistant help you craft the perfect search strategy.
                </p>
            </div>
            
            <!-- Main Search Interface -->
            <div class="max-w-6xl mx-auto" x-data="searchApp()" x-init="init()">
                <div class="glass rounded-2xl p-8 search-box-shadow">
                    
                    <!-- Query Type Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-list-ul text-primary-500 mr-2"></i>
                            Query Type
                        </label>
                        <select 
                            x-model="queryType"
                            @change="queryTypeChanged"
                            class="w-full md:w-64 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all bg-white font-semibold text-gray-700"
                            :disabled="searching">
                            <option value="general">General Question</option>
                            <option value="doctor_evaluation">Doctor Good/Bad</option>
                        </select>
                    </div>

                    <!-- Doctor Name Input (Only shown for Doctor Good/Bad) -->
                    <div x-show="queryType === 'doctor_evaluation'" class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-user-md text-primary-500 mr-2"></i>
                            Doctor Name
                        </label>
                        <input 
                            type="text"
                            x-model="doctorName"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all"
                            placeholder="e.g., Dr. John Smith or Smith"
                            :disabled="searching">
                        <p class="mt-2 text-xs text-gray-500">
                            <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                            Enter the doctor's name. The system will search for all messages mentioning this doctor and provide an evaluation.
                        </p>
                    </div>
                    
                    <!-- AI Intent Box (Only shown for General Question) -->
                    <div x-show="queryType === 'general'" class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-brain text-primary-500 mr-2"></i>
                            What are you trying to find? (Optional AI Assistant)
                        </label>
                        <textarea 
                            x-model="aiIntent"
                            @input="aiIntentChanged"
                            rows="2"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all resize-none"
                            placeholder="e.g., 'I need recent cases where injured workers were denied medical treatment for back injuries'"
                            :disabled="searching"
                        ></textarea>
                        <div class="mt-2 flex items-center justify-between">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                The AI will analyze your intent and manual search fields to suggest the best strategy
                            </p>
                            <button 
                                type="button"
                                @click="askAI"
                                x-show="queryType === 'general'"
                                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="searching || aiAnalyzing || !aiIntent || aiIntent.trim().length === 0">
                                <span x-show="!aiAnalyzing">
                                    <i class="fas fa-magic mr-2"></i>
                                    Ask AI Assistant
                                </span>
                                <span x-show="aiAnalyzing">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    Analyzing...
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- AI Conversation Box (Shows when AI is active) -->
                    <div x-show="aiConversation.length > 0" 
                         class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-robot text-purple-600 mr-2"></i>
                            AI Assistant
                        </h3>
                        
                        <!-- Conversation Messages -->
                        <div class="space-y-4 mb-4 max-h-96 overflow-y-auto">
                            <template x-for="(msg, index) in aiConversation" :key="index">
                                <div>
                                    <!-- AI Message -->
                                    <div x-show="msg.role === 'ai'" class="flex items-start space-x-3">
                                        <div class="flex-shrink-0 w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center">
                                            <i class="fas fa-robot text-white text-sm"></i>
                                        </div>
                                        <div class="flex-1 bg-white p-4 rounded-lg shadow-sm">
                                            <!-- Only show content if there's no follow-up question -->
                                            <p x-show="!msg.question" class="text-gray-800 whitespace-pre-line" x-text="msg.content"></p>
                                            
                                            <!-- AI Suggested Search Parameters -->
                                            <div x-show="msg.suggestions" class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                                                <p class="font-semibold text-sm text-gray-900 mb-2">
                                                    <i class="fas fa-sparkles text-purple-500 mr-1"></i>
                                                    Suggested Search Parameters:
                                                </p>
                                                <div class="text-sm text-gray-700 space-y-1" x-html="formatSuggestions(msg.suggestions)"></div>
                                                
                                                <div class="mt-4 flex space-x-3">
                                                    <button 
                                                        @click="applySuggestions(msg.suggestions)"
                                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold">
                                                        <i class="fas fa-check mr-2"></i>
                                                        Apply These Settings
                                                    </button>
                                                    <button 
                                                        @click="rejectSuggestions"
                                                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm font-semibold">
                                                        <i class="fas fa-times mr-2"></i>
                                                        Keep My Settings
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- AI Follow-up Question -->
                                            <div x-show="msg.question" class="mt-4">
                                                <p class="text-sm font-semibold text-gray-900 mb-2" x-text="msg.question"></p>
                                                
                                                <!-- Only show input for the last message -->
                                                <template x-if="index === aiConversation.length - 1">
                                                    <div>
                                                        <input 
                                                            type="text"
                                                            x-model="followUpAnswer"
                                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                                            placeholder="Your answer..."
                                                            @keyup.enter="answerFollowUp">
                                                        <button 
                                                            @click="answerFollowUp"
                                                            class="mt-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                                                            <i class="fas fa-paper-plane mr-2"></i>
                                                            Send Answer
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- User Message -->
                                    <div x-show="msg.role === 'user'" class="flex items-start space-x-3 justify-end">
                                        <div class="bg-primary-600 text-white p-4 rounded-lg shadow-sm max-w-md">
                                            <p x-text="msg.content"></p>
                                        </div>
                                        <div class="flex-shrink-0 w-8 h-8 bg-primary-600 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-white text-sm"></i>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Manual Search Fields (Only shown for General Question) -->
                    <form @submit.prevent="submitSearch">
                        <div x-show="queryType === 'general'" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            
                            <!-- First Name (Witness/Expert) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    First Name
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.first_name"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Witness/Expert first name"
                                    :disabled="searching">
                            </div>

                            <!-- Last Name (Witness/Expert) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Last Name
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.last_name"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Witness/Expert last name"
                                    :disabled="searching">
                            </div>

                            <!-- Simple Keyword -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Keyword Search
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.keyword"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Simple keyword"
                                    :disabled="searching">
                            </div>

                            <!-- All Keywords -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    All These Keywords
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.keywords_all"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Must contain all"
                                    :disabled="searching">
                            </div>

                            <!-- Exact Phrase -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Exact Phrase
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.keywords_phrase"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Exact phrase match"
                                    :disabled="searching">
                            </div>

                            <!-- Any Keywords -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Any of These Keywords
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.keywords_any"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="At least one"
                                    :disabled="searching">
                            </div>

                            <!-- Exclude Keywords -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Exclude Keywords
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.keywords_exclude"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Must not contain"
                                    :disabled="searching">
                            </div>

                            <!-- Listserv -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Listserv
                                </label>
                                <select 
                                    x-model="searchFields.listserv"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    :disabled="searching">
                                    <option value="all">All Lists</option>
                                    <option value="lawnet">LawNET (Applicant Attorneys)</option>
                                    <option value="lavaaa">LAVAAA (Defense Attorneys)</option>
                                    <option value="lamaaa">LAMAAA</option>
                                    <option value="scaaa">SCAAA</option>
                                </select>
                            </div>

                            <!-- Date From -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Date From
                                </label>
                                <input 
                                    type="date"
                                    x-model="searchFields.date_from"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    :disabled="searching">
                            </div>

                            <!-- Date To -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Date To
                                </label>
                                <input 
                                    type="date"
                                    x-model="searchFields.date_to"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    :disabled="searching">
                            </div>

                            <!-- Posted By -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Posted By
                                </label>
                                <input 
                                    type="text"
                                    x-model="searchFields.posted_by"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    placeholder="Author name/email"
                                    :disabled="searching">
                            </div>

                            <!-- Search In -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Search In
                                </label>
                                <select 
                                    x-model="searchFields.search_in"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    :disabled="searching">
                                    <option value="subject_and_body">Subject and Body</option>
                                    <option value="subject_only">Subject Only</option>
                                </select>
                            </div>

                            <!-- Attachments -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Attachments
                                </label>
                                <select 
                                    x-model="searchFields.attachments"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all"
                                    :disabled="searching">
                                    <option value="">Any</option>
                                    <option value="1">With Attachments</option>
                                    <option value="0">Without Attachments</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Options & Submit (Always visible) -->
                        <div class="flex items-center justify-between pt-6 border-t">
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-semibold text-gray-700">
                                    Max Messages:
                                </label>
                                <select 
                                    x-model.number="maxMessages"
                                    class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-100 transition-all bg-white font-semibold text-primary-600"
                                    :disabled="searching">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="75">75</option>
                                    <option value="100">100</option>
                                    <option value="150">150</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                            
                            <button 
                                type="submit"
                                class="px-8 py-3 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                :disabled="searching || (queryType === 'general' && !hasAnySearchCriteria()) || (queryType === 'doctor_evaluation' && !doctorName.trim())">
                                <span x-show="!searching" class="flex items-center">
                                    <i class="fas mr-2" :class="queryType === 'doctor_evaluation' ? 'fa-user-md' : 'fa-search'"></i>
                                    <span x-text="queryType === 'doctor_evaluation' ? 'Evaluate Doctor' : 'Search & Analyze'"></span>
                                </span>
                                <span x-show="searching" class="flex items-center">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    Processing...
                                </span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Status Message -->
                    <div x-show="statusMessage" 
                         class="mt-4 p-4 rounded-lg" 
                         :class="statusType === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'">
                        <span x-text="statusMessage"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="glass rounded-xl p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Total Searches</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" x-text="stats.total_searches"></p>
                    </div>
                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-search text-primary-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Messages Analyzed</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" x-text="stats.total_messages"></p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Relevant Results</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" x-text="stats.total_relevant"></p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Active Searches</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" x-text="stats.running_searches"></p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-spinner fa-pulse text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div> <!-- Close stats grid -->
            
            <!-- Search History Section -->
            <div class="mt-16 glass p-8 rounded-2xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-history text-primary-600 mr-3"></i>
                    Recent Search History
                    <span class="ml-3 text-sm text-gray-500" x-text="'(' + searchHistory.length + ' searches)'"></span>
                </h2>
                
                <!-- Debug -->
                <div class="mb-4 p-4 bg-yellow-50 text-xs">
                    <strong>DEBUG:</strong> searchHistory type: <span x-text="typeof searchHistory"></span>, 
                    length: <span x-text="searchHistory.length"></span>,
                    is array: <span x-text="Array.isArray(searchHistory)"></span><br>
                    <strong>TEST stats variable:</strong> total_searches = <span x-text="stats.total_searches"></span><br>
                    <strong>TEST maxMessages variable:</strong> <span x-text="maxMessages"></span>
                </div>
                
                <div x-show="searchHistory.length === 0" class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                    <p>No searches yet. Start your first search above!</p>
                </div>
                
                <div x-show="searchHistory.length > 0" class="space-y-4">
                    <template x-for="search in searchHistory" :key="search.id">
                        <div class="bg-white p-6 rounded-lg border border-gray-200 hover:border-primary-300 transition-colors">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900 mb-1" x-text="search.ai_intent || search.query"></h3>
                                    <p class="text-sm text-gray-500" x-text="new Date(search.created_at).toLocaleString()"></p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-medium"
                                      :class="{
                                          'bg-green-100 text-green-800': search.status === 'completed',
                                          'bg-blue-100 text-blue-800': search.status === 'analyzing',
                                          'bg-yellow-100 text-yellow-800': search.status === 'running'
                                      }"
                                      x-text="search.status"></span>
                            </div>
                            
                            <div class="flex items-center justify-between mt-4">
                                <div class="flex gap-4 text-sm text-gray-600">
                                    <span class="flex items-center">
                                        <i class="fas fa-file-alt mr-1"></i>
                                        <span x-text="search.result_count"></span> results
                                    </span>
                                    <span class="flex items-center text-green-600" x-show="search.relevant_count > 0">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        <span x-text="search.relevant_count"></span> relevant
                                    </span>
                                </div>
                                <a :href="`/results.html?id=${search.id}`" 
                                   class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center">
                                    View Results
                                    <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            </div> <!-- Close searchApp x-data div -->

    </div>

    <script>
        function searchApp() {
            return {
                // Query Type
                queryType: 'general',
                doctorName: '',
                
                // AI Intent
                aiIntent: '',
                aiAnalyzing: false,
                aiConversation: [],
                followUpAnswer: '',
                
                // Manual Search Fields
                searchFields: {
                    keyword: '',
                    keywords_all: '',
                    keywords_phrase: '',
                    keywords_any: '',
                    keywords_exclude: '',
                    listserv: 'all',
                    date_from: '',
                    date_to: '',
                    posted_by: '',
                    search_in: 'subject_and_body',
                    attachments: '',
                    first_name: '',
                    last_name: ''
                },
                
                searching: false,
                statusMessage: '',
                statusType: '',
                maxMessages: 50,  // Default max messages to search
                stats: {
                    total_searches: 0,
                    total_messages: 0,
                    total_relevant: 0,
                    running_searches: 0
                },
                searchHistory: [],
                
                async init() {
                    await this.fetchStats();
                    await this.fetchHistory();
                    // Refresh stats every 10 seconds
                    setInterval(() => this.fetchStats(), 10000);
                },
                
                async fetchStats() {
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        this.stats = data;
                    } catch (err) {
                        console.error('Error fetching stats:', err);
                    }
                },
                
                async fetchHistory() {
                    console.log('ðŸ” Fetching search history...');
                    try {
                        const response = await fetch('/api/search-history');
                        console.log('History response status:', response.status);
                        const data = await response.json();
                        console.log('History data:', data);
                        if (data.success && data.history) {
                            this.searchHistory = data.history;
                            console.log('âœ… Loaded', data.history.length, 'searches');
                        } else {
                            console.warn('âš ï¸ No history in response');
                        }
                    } catch (err) {
                        console.error('âŒ Error fetching history:', err);
                        // Fallback to direct backend URL if proxy doesn't exist yet
                        try {
                            console.log('Trying fallback URL...');
                            const response = await fetch('http://134.199.196.31:8000/api/search-history');
                            const data = await response.json();
                            console.log('Fallback data:', data);
                            if (data.success && data.history) {
                                this.searchHistory = data.history;
                                console.log('âœ… Loaded', data.history.length, 'searches via fallback');
                            }
                        } catch (err2) {
                            console.error('âŒ Fallback also failed:', err2);
                        }
                    }
                },
                
                hasAnySearchCriteria() {
                    return Object.values(this.searchFields).some(val => 
                        val && val !== 'all' && val !== 'subject_and_body'
                    );
                },
                
                aiIntentChanged() {
                    // Could add auto-suggestions here
                },
                
                async askAI() {
                    if (!this.aiIntent.trim()) return;
                    
                    this.aiAnalyzing = true;
                    
                    // Add user message to conversation
                    this.aiConversation.push({
                        role: 'user',
                        content: this.aiIntent
                    });
                    
                    try {
                        const response = await fetch('/api/ai/analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                intent: this.aiIntent,
                                current_fields: this.searchFields
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Add AI response to conversation
                            this.aiConversation.push({
                                role: 'ai',
                                content: data.analysis,
                                suggestions: data.suggestions,
                                question: data.follow_up_question
                            });
                        } else {
                            throw new Error(data.detail || 'AI analysis failed');
                        }
                    } catch (error) {
                        this.statusMessage = `AI Error: ${error.message}`;
                        this.statusType = 'error';
                    } finally {
                        this.aiAnalyzing = false;
                    }
                },
                
                formatSuggestions(suggestions) {
                    if (!suggestions) return '';
                    let html = '<div class="space-y-1">';
                    for (let key in suggestions) {
                        if (suggestions[key]) {
                            let value = suggestions[key];
                            // Convert objects/arrays to strings properly
                            if (typeof value === 'object') {
                                value = JSON.stringify(value);
                            }
                            html += `<div><strong>${this.fieldLabel(key)}:</strong> ${value}</div>`;
                        }
                    }
                    html += '</div>';
                    return html;
                },
                
                fieldLabel(key) {
                    const labels = {
                        keyword: 'Keyword',
                        keywords_all: 'All Keywords',
                        keywords_phrase: 'Exact Phrase',
                        keywords_any: 'Any Keywords',
                        keywords_exclude: 'Exclude',
                        listserv: 'Listserv',
                        date_from: 'Date From',
                        date_to: 'Date To',
                        posted_by: 'Posted By',
                        search_in: 'Search In',
                        attachments: 'Attachments',
                        first_name: 'First Name',
                        last_name: 'Last Name'
                    };
                    return labels[key] || key;
                },
                
                applySuggestions(suggestions) {
                    // Apply AI suggestions to search fields
                    for (let key in suggestions) {
                        if (key in this.searchFields) {
                            this.searchFields[key] = suggestions[key];
                        }
                    }
                    
                    this.statusMessage = 'AI suggestions applied! Review and search when ready.';
                    this.statusType = 'success';
                    
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 3000);
                },
                
                rejectSuggestions() {
                    this.statusMessage = 'Keeping your original search settings.';
                    this.statusType = 'success';
                    
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 2000);
                },
                
                async answerFollowUp() {
                    if (!this.followUpAnswer.trim()) return;
                    
                    // Add user's answer to conversation
                    this.aiConversation.push({
                        role: 'user',
                        content: this.followUpAnswer
                    });
                    
                    const answer = this.followUpAnswer;
                    this.followUpAnswer = '';
                    
                    // Continue AI conversation
                    this.aiAnalyzing = true;
                    
                    try {
                        // Create AbortController with 60 second timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 60000);
                        
                        const response = await fetch('/api/ai/follow-up', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                answer: answer,
                                conversation: this.aiConversation,
                                current_fields: this.searchFields
                            }),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.aiConversation.push({
                                role: 'ai',
                                content: data.analysis,
                                suggestions: data.suggestions,
                                question: data.follow_up_question
                            });
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    } catch (error) {
                        // Remove the user's answer from conversation on error
                        this.aiConversation.pop();
                        
                        let errorMsg = error.message;
                        if (error.name === 'AbortError') {
                            errorMsg = 'AI is taking too long. Please try again.';
                        }
                        
                        this.statusMessage = `AI Error: ${errorMsg}`;
                        this.statusType = 'error';
                    } finally {
                        this.aiAnalyzing = false;
                    }
                },
                
                queryTypeChanged() {
                    // Reset doctor name when switching away from doctor evaluation
                    if (this.queryType !== 'doctor_evaluation') {
                        this.doctorName = '';
                    }
                    // Clear AI conversation when switching query types
                    this.aiConversation = [];
                    this.aiIntent = '';
                },
                
                async submitSearch() {
                    // For doctor evaluation, require doctor name
                    if (this.queryType === 'doctor_evaluation' && !this.doctorName.trim()) {
                        this.statusMessage = 'Please enter a doctor name for evaluation.';
                        this.statusType = 'error';
                        return;
                    }
                    
                    // For general queries, require search criteria
                    if (this.queryType === 'general' && !this.hasAnySearchCriteria()) {
                        return;
                    }
                    
                    this.searching = true;
                    this.statusMessage = '';
                    
                    try {
                        // Build request body based on query type
                        const requestBody = {
                            query_type: this.queryType,
                            max_messages: this.maxMessages,
                            max_pages: 10
                        };
                        
                        if (this.queryType === 'doctor_evaluation') {
                            // For doctor evaluation, use doctor name as AI intent
                            requestBody.ai_intent = `Evaluate doctor: ${this.doctorName.trim()}`;
                            requestBody.use_ai_enhancement = true;
                        } else {
                            // For general queries, use existing logic
                            requestBody.search_fields = this.searchFields;
                            requestBody.ai_intent = this.aiIntent;
                            requestBody.use_ai_enhancement = false;
                        }
                        
                        const response = await fetch('/api/search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.statusMessage = 'Search started! Redirecting to results...';
                            this.statusType = 'success';
                            
                            setTimeout(() => {
                                window.location.href = `/results.html?id=${data.search_id}`;
                            }, 1000);
                        } else {
                            throw new Error(data.detail || 'Search failed');
                        }
                    } catch (error) {
                        this.statusMessage = `Error: ${error.message}`;
                        this.statusType = 'error';
                        this.searching = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
